name: CI/CD Pipeline

# Definir los eventos que activan el flujo de trabajo
on:
  push:
    branches:
      - main   # Ejecutar en cada 'push' a la rama 'main'
  pull_request:
    branches:
      - main   # Ejecutar también en 'pull requests' hacia la rama 'main'

jobs:
  # Job de pruebas (Ejecutar tests de la aplicación)
  test:
    runs-on: ubuntu-latest    # Utiliza una máquina virtual Ubuntu para ejecutar este job
    services:
      mongodb:
        image: mongo:5.0   # Cambiar la versión para usar una más estable
        ports:
          - 27017:27017     # Exponer el puerto de MongoDB
        options: --health-cmd="mongo --eval 'db.adminCommand(\"ping\")' --quiet" --health-interval=10s --health-timeout=5s --health-retries=5

    steps:
      - name: Check out the repository
        uses: actions/checkout@v2   # Obtener el código del repositorio

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'   # Instalar Python 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip   # Actualizar pip
          pip install -r requirements.txt   # Instalar las dependencias de Python

      - name: Increase vm.max_map_count
        run: sudo sysctl -w vm.max_map_count=16777220   # Ajustar parámetro de memoria

      - name: Test MongoDB connection
        run: |
          until nc -zv 127.0.0.1 27017; do
            echo "Waiting for MongoDB to start..."
            sleep 5
          done
          echo "MongoDB is ready!"

      #- name: Run tests
        # CAMBIO AQUÍ: Ejecutar pytest como un módulo de Python
        #run: |
         # python -m pytest tests/   # Ejecutar los tests con pytest (si tienes tests en la carpeta 'tests')

  # Job para construir y subir la imagen Docker
  build_and_push_docker_image:
    needs: test   # Este job depende de que 'test' haya sido exitoso
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}   # Credenciales de Docker (Guardadas en Secrets)
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        # Asegúrate de que este comando se ejecuta en el directorio correcto si tu Dockerfile no está en la raíz del repo
        # Por ejemplo, si tu Dockerfile está en python-flask-mongodb-crud-task/, necesitarías:
        # run: |
        #   cd python-flask-mongodb-crud-task/
        #   docker build -t my-flask-app .
        run: |
          docker build -t my-flask-app .   # Construir la imagen con el Dockerfile en la raíz

      - name: Push Docker image to Docker Hub
        # Asegúrate de que el nombre de la imagen coincida con el nombre que usaste en el paso 'Build Docker image'
        run: |
          docker push my-flask-app   # Subir la imagen a Docker Hub

  # Job para desplegar la infraestructura con Terraform (opcional)
  terraform:
    needs: build_and_push_docker_image   # Este job depende de que 'build_and_push_docker_image' haya sido exitoso
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v2

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v1   # Instalar Terraform

      - name: Initialize Terraform
        # Si tu configuración de Terraform está en mi-atlas-terraform/, necesitas navegar a esa carpeta
        # run: |
        #   cd mi-atlas-terraform/
        #   terraform init
        run: terraform init   # Inicializar la configuración de Terraform

      - name: Terraform Plan
        # Si tu configuración de Terraform está en mi-atlas-terraform/, necesitas navegar a esa carpeta
        # run: |
        #   cd mi-atlas-terraform/
        #   terraform plan
        run: terraform plan   # Ver qué cambios va a hacer Terraform

      - name: Apply Terraform
        # Si tu configuración de Terraform está en mi-atlas-terraform/, necesitas navegar a esa carpeta
        # run: |
        #   cd mi-atlas-terraform/
        #   terraform apply -auto-approve
        run: terraform apply -auto-approve   # Aplicar los cambios sin necesidad de confirmación
